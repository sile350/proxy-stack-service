# ============================================================
# Docker Compose — 3Proxy + HAProxy Proxy Stack (Ubuntu 24.04)
# ============================================================
# Запуск: sudo docker compose up -d --build
# Статус: sudo docker compose ps
# Логи:   sudo docker compose logs -f proxy-stack
# Стоп:   sudo docker compose down
#
# Чтобы работать без sudo:
#   sudo usermod -aG docker $USER && newgrp docker

services:
  proxy-stack:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        THREEPROXY_VERSION: "0.9.4"
    image: proxy-stack:ubuntu-24.04
    container_name: proxy-stack
    hostname: proxy-stack
    restart: unless-stopped
    # Dual-stack IPv4/IPv6
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=0
      - net.core.somaxconn=65535
      - net.ipv4.tcp_tw_reuse=1
    ports:
      # HTTP Proxy (HAProxy frontend)
      - "3128:3128"
      # SOCKS5 Proxy (HAProxy frontend)
      - "1080:1080"
      # Monitoring (Prometheus metrics + health) — только localhost
      - "127.0.0.1:9100:9100"
      # HAProxy Stats — только localhost
      - "127.0.0.1:8404:8404"
    volumes:
      # Конфигурация (монтируем для удобства редактирования)
      - ./config.yml:/opt/proxy-stack/config.yml:ro
      # Логи (persistent)
      - proxy-logs:/var/log/proxy-stack
      # Runtime (PID-файлы)
      - proxy-run:/var/run/proxy-stack
    environment:
      - PYTHONUNBUFFERED=1
      - LANG=C.UTF-8
    # Ресурсные лимиты
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 512M
        reservations:
          cpus: "0.5"
          memory: 128M
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
      nproc:
        soft: 4096
        hard: 4096
    # Capabilities (для привязки к привилегированным портам)
    cap_add:
      - NET_BIND_SERVICE
    cap_drop:
      - ALL
    # Security
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp:size=64M
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://127.0.0.1:9100/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        tag: "proxy-stack"
    networks:
      - proxy-net

networks:
  proxy-net:
    driver: bridge
    enable_ipv6: true
    ipam:
      config:
        - subnet: 172.28.0.0/16
        - subnet: fd00:dead:beef::/48

volumes:
  proxy-logs:
    driver: local
  proxy-run:
    driver: local
